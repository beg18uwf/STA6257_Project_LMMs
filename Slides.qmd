---
title: "Linear Mixed-Effects Models"
author: "Nick Freeland, Bernice Green, Gary Marmon"
format:
  revealjs: 
    theme: league
    preview-links: auto

---

# Introduction

```{r}

#| include: false

# loading packages 
library(tidyverse)
library(knitr)
library(ggthemes)
library(ggrepel)
library(dslabs)
library(nflverse)
library(nflplotR)
library(kableExtra)
library(GLMsData)
library(ggfortify)
library(gridExtra)
library(lme4)
library(lmerTest)

# loading play by play data from the 2021 NFL season
pbp <- nflreadr::load_pbp(2021)

# team summaries 
team_sum1 <- data.frame(pbp$game_id, pbp$home_coach, pbp$away_coach, pbp$posteam, pbp$posteam_type, pbp$pass, pbp$rush, pbp$epa, pbp$down, pbp$week, pbp$season_type, pbp$yards_gained, pbp$shotgun, pbp$no_huddle, pbp$yards_after_catch)

team_sum2 <- team_sum1 %>%
  filter(pbp.rush == 1 | pbp.pass == 1, !is.na(pbp.down)) %>%
  group_by (pbp.posteam, pbp.posteam_type, pbp.game_id) %>%
  mutate(coach = ifelse(pbp.posteam_type == 'home',pbp.home_coach,pbp.away_coach)) %>%
  mutate(opp_coach = ifelse(pbp.posteam_type == 'away',pbp.home_coach,pbp.away_coach)) %>%
  mutate(home_adv = ifelse(pbp.posteam_type == 'home', 0, 1))%>%
  summarize(week = first(pbp.week),
            season_type = first(ifelse(pbp.season_type == 'REG', 0, 1)),
            home_adv = first(home_adv),
            coach = first(coach),
            opp_coach = first(opp_coach),
            plays = n(),
            pass_plays = sum(pbp.pass),
            pass_pct = pass_plays / plays,
            yards_gained = sum(pbp.yards_gained),
            shotgun_snaps = sum(pbp.shotgun),
            no_huddle_snap = sum(pbp.no_huddle),
            epa_per_play = round(mean(pbp.epa), digits = 2))

```

## Simple Linear Regressions

-   assumes independence of observations

-   slopes and intercepts measure average trends

```{r Linear Regression, echo=FALSE, warning=FALSE}
x <- c(9,9,7,8,7,8,4,5,5,4,6,2,1,3,3,2,1,2,1,0,2,8,10,9,7.5,6,10)
y <- c(0,1,0,2,2,1,3,4,5,4,6,5,5,6,8,7,7,8,9,9,9,5,3,4,0,0,4)
z <- c('A','A','A','A','A','A','B','B','B','B','B','B','B','B','C','C','C','C','C','C','C','A','A','A','A','A','A')


data <- data.frame(x,y,z)

slr <- ggplot(data, aes(x, y)) + 
    geom_point(size=4) + # change size and colour
   scale_y_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # y axis limits/range (0, 100), break points
    scale_x_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # x axis limits/range 
    geom_smooth(method = 'lm', se = F) # fit linear regression line

slr
```

# But...

What if the observations are not independent?

What if trends vary between clusters?

```{r}
slr.col <- ggplot(data, aes(x, y, col = z)) + 
    geom_point(size=4) + # change size and colour
    scale_y_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # y axis limits/range (0, 100), break points
    scale_x_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # x axis limits/range 
    geom_smooth(method = 'lm', se = F, aes(group = 1)) # fit linear regression line

slr.col
```

## Linear Mixed-Effects Models (LMMs)

-   LMMs can be used to model correlated data
    -   Cross sectional data: individuals nested in a geographical or social context - *ex: Student test data compared across Geometry classes*

    -   Longitudinal data: repeated measures of individuals - *ex: Student test data over time*

Main application for mixed-effect models is in psychology due to the nature of their data and repeated observations across trial participants

```{r}
lmm <- ggplot(data, aes(x, y, col = z)) + 
    geom_point(size=4) + # change size and colour
    scale_y_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # y axis limits/range (0, 100), break points
    scale_x_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # x axis limits/range 
    geom_smooth(method = 'lm', se = F)  # fit linear regression line

lmm
```

## Fixed vs. Random Effects

-Fixed Effects 
  -   show average trends for the population
  -   assume constant relationship between response and exploratory features
  -   infer/predict about levels included in the training data

. . .

-Random Effects 
  -   show how trends vary across groups
  -   assumes constant relationship between response and exploratory features but relationship may vary between groups
  -   infer/predict about all levels in the population

## Fixed and Random Effects

-   mixed-effects models simultaneously model fixed and random effects

-   fixed effect parameters

    -   small number of clusters, large number of observations

-   random effect parameters

    -   large number of clusters, small number of clusters per observation

**It's important to include the random effects in the model since fixed effects only give a partial picture of hierarchical data.**

## Linear Model vs Linear Mixed-Effects Model

```{r}
slr.lmm <- ggplot(data, aes(x, y, col = z)) + 
    geom_point(size=4) + # change size and colour
    scale_y_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # y axis limits/range (0, 100), break points
    scale_x_continuous(limits = c(0, 10), breaks = c(0, 2, 4, 6, 8, 10)) + # x axis limits/range 
    geom_smooth(method = 'lm', se = F) + # fit linear regression line
    geom_smooth(method = 'lm', se = F, aes(group = 1)) # fit linear regression line

slr.lmm
```

# [Methods and Data](https://nfreeland.github.io/linear-mixed-effect-models-slides.html#(1)){preview-link="true"}

# Data

##  {.scrollable}

Our data featured a play by play analysis for every game in the 2021 season.

| Variable         | Meaning                                                                 |
|:--------------------|:--------------------------------------------------|
| pbp.posteam      | the team with possession of the ball (offense)                          |
| pbp.posteam_type | specifies if the possessing team is home or away                        |
| pbp.game_id      | the specific game id from the NFL                                       |
| week             | week number in the season that the game was played                      |
| season_type      | flag that specifies if it is a regular (0) or post (1) season game      |
| home_adv         | flag that specifies home (0) or away(1)                                 |
| coach            | the coach of the team with possession (offensive plays)                 |
| opp_coach        | the coach of the opposing team (defensive plays)                        |
| plays            | total number of rush and pass plays given the team and game             |
| pass_plays       | number of pass plays given the team and game                            |
| pass_pct         | the percentage of pass plays in the game calculated by pass_plays/plays |
| yards_gained     | yards gained by an offense                                              |
| shotgun_snaps    | number of snaps a team lined up in a shotgun formation                  |
| ho_huddle_snaps  | number of snaps a team used a no huddle offense                         |
| EPA_per_play     | the mean of all pass and rush plays given team and game                 |

------------------------------------------------------------------------

```{r, warning=FALSE, echo=TRUE}
# Compare EPA by coach
ggplot(team_sum2, aes(epa_per_play)) +
  geom_boxplot() +
  facet_wrap(~ coach) +
  theme_minimal()
  
```

# Analysis

##  {.scrollable}

```{r}
#| include: true
#| echo: true


# LMM - random intercepts
epa.lmer1 = lmer(epa_per_play ~ pass_pct + plays + yards_gained + no_huddle_snap + 
(1|coach) + (1|home_adv), data=team_sum2)

epa.lmer1
```

-home advantage random effect approaches zero - no additional change in EPA per play due to home field advantage -additional 0.02 EPA per play due to coaching

------------------------------------------------------------------------

```{r}
#| include: true
#| echo: true

# LMM - random slopes
epa.lmer2 = lmer(epa_per_play ~ pass_pct + plays + yards_gained + shotgun_snaps + no_huddle_snap +
(1+pass_pct|coach) + (1+plays|coach) + (1+yards_gained|coach) + (1+shotgun_snaps|coach) + (1+no_huddle_snap|coach), data=team_sum2)
```

-   different baseline levels of plays ran and pass_pct
    -   all the values are negative and very close to each other
-   there's consistency with how often coaches throw the ball -variation in number of shotgun snaps an offense runs is much wider

------------------------------------------------------------------------

```{r}
#| include: true
#| echo: true


# Testing for significance between models with and without home field advantage
epa.lmer2.null = lmer(epa_per_play ~ pass_pct + plays + yards_gained + shotgun_snaps + no_huddle_snap +
                  (1+pass_pct|coach) + (1+plays|coach) + (1+yards_gained|coach) + (1+shotgun_snaps|coach) + (1+no_huddle_snap|coach),                                            data=team_sum2,
                  REML=FALSE)

epa.lmer2.full = lmer(epa_per_play ~ home_adv + pass_pct + plays + yards_gained + shotgun_snaps + no_huddle_snap +
                  (1+home_adv|coach) + (1+pass_pct|coach) + (1+plays|coach) + (1+yards_gained|coach) + (1+shotgun_snaps|coach) + (1+no_huddle_snap|coach),                       data=team_sum2,
                  REML=FALSE)

anova(epa.lmer2.full, epa.lmer2.null)

```

-   no statistical significance between the models -the effect of home field advantage is minimal to zero

# Conclusion

After accounting for the fixed effects plays ran, percentage of pass plays, yards gained, shotgun snaps, and no huddle snaps, our random effect coefficient for coaching showed an additional change 0.02 EPA per play due to coaching and no change in EPA per play due to home field advantage.
